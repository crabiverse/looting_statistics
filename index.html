<!DOCTYPE html>
<html>

<head>
    <title>Revenue statistics</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^3"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@^2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@^1"></script>
</head>

<style>
    html,
    body {
        font-family: Tahoma;
        font-size: 16px;
        text-align: center;
        scroll-behavior: smooth;
    }

    .button {
        border-radius: 8px;
        border: none;
        background-color: #56A5E1;
        color: white;
        font-family: Tahoma;
        font-size: 13px;
        text-align: center;
        padding: 10px 15px;
        cursor: pointer;
    }

    .button:hover {
        background-color: #438cc3;
    }

    .nav {
        border: 1px solid #ccc;
        border-width: 1px 0;
        list-style: none;
        margin: 0;
        padding: 0;
        text-align: center;
    }

    .nav li {
        display: inline;
    }

    .nav a {
        display: inline-block;
        padding: 10px;
    }

    table {
        border-collapse: collapse;
        margin-left: auto;
        margin-right: auto;
    }

    td,
    th {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }

    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    tr:hover {
        background-color: #ddd;
    }

    th {
        padding-top: 12px;
        padding-bottom: 12px;
        background-color: #04AA6D;
    }

    .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        margin-left: auto;
        margin-right: auto;
    }

    .tab button {
        background-color: inherit;
        float: center;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
        font-size: 17px;
    }

    .tab button:hover {
        background-color: #ddd;
    }

    .tab button.active {
        background-color: #ccc;
    }

    .tabcontent {
        display: none;
        padding: 20px 12px;
        border: 1px solid #ccc;
        border-top: none;
    }
</style>

<body onload="checkSettings();">
<ul class="nav">
    <li><a href="https://crabada-resources.github.io/pure_sniping/">Crab Finder</a></li>
    <li><a href="https://crabada-resources.github.io/breeding_calculator/">Breeding calculator</a></li>
</ul>


<div id="header">
    <h2>Revenue statistics</h2>
    <br></br>
    <form id="crabs_settings" onsubmit="return false">
        Enter your wallet ID: &nbsp;&nbsp; <input id="wallet" style="width: 20em"/>
        <br></br>
        <button id="calculateBtn" class="button" onclick="calculate()">Calculate revenue</button>
    </form>


    <p id="loading"></p>
    <div id="results" style="display: none">
        <br></br>
        <h3> Results </h3>
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'summary')" id="tab_1">Summary</button>
            <button class="tablinks" onclick="openTab(event, 'mining')" id="tab_2">Mining</button>
            <button class="tablinks" onclick="openTab(event, 'looting')" id="tab_3">Looting</button>
            <button class="tablinks" onclick="openTab(event, 'renting')" id="tab_4">Renting</button>
        </div>

        <div id="summary" class="tabcontent">
            <div id="results_text_summary"></div>
            <div id="chart_container_summary"
                 style="margin: auto; padding-top: 2%; padding-bottom: 2%;  width:30vw">
                <canvas id="tus_revenue_chart_summary"></canvas>
            </div>
            <div id="results_table_summary"></div>
        </div>

        <div id="mining" class="tabcontent">
            <div id="results_text_mine"></div>
            <div id="chart_container_mine" style="margin: auto; padding-top: 2%; padding-bottom: 2%;  width:30vw">
                <canvas id="tus_revenue_chart_mine"></canvas>
            </div>
            <div id="results_table_mine"></div>
        </div>

        <div id="looting" class="tabcontent">
            <div id="results_text_loot"></div>
            <div id="chart_container_loot" style="margin: auto; padding-top: 2%; padding-bottom: 2%; width:30vw">
                <canvas id="tus_revenue_chart_loot"></canvas>
            </div>
            <div id="results_table_loot"></div>
        </div>

        <div id="renting" class="tabcontent">
            <div id="results_text_tavern"></div>
            <div id="chart_container_tavern" style="margin: auto; padding-top: 2%; padding-bottom: 2%;  width:30vw">
                <canvas id="tus_revenue_chart_tavern"></canvas>
            </div>
            <div id="results_table_tavern"></div>
        </div>

    </div>
</div>
</body>
<script type="text/javascript">
  var sync_data;

  function openTab(evt, cityName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(cityName).style.display = "block";
    evt.currentTarget.className += " active";
  }

  function GetURLParameter(sParam) {
    const sPageURL = window.location.search.substring(1);
    const sURLVariables = sPageURL.split('&');
    for (let i = 0; i < sURLVariables.length; i++) {
      const sParameterName = sURLVariables[i].split('=');
      if (sParameterName[0] == sParam) {
        return sParameterName[1];
      }
    }
  }

  function checkSettings() {
    let wallet = document.getElementById("wallet");

    let parameterwaller = GetURLParameter('wallet');
    if (parameterwaller != null) {
      wallet.setAttribute("value", parameterwaller);
      calculate()
    } else if (localStorage.getItem("wallet") != null) {
      wallet.setAttribute("value", localStorage.getItem("wallet"));
    } else {
      wallet.setAttribute("placeholder", "");
    }
  }

  function updateData(input_data) {
    console.log("update: " + input_data);

    sync_data.push(input_data);
  }

  function calculate() {
    clearForm()
    let wallet = document.getElementById("wallet").value;
    let loading = document.getElementById("loading");

    loading.innerHTML = "Loading...";

    let results = document.getElementById("results");

    let results_text_loot = document.getElementById("results_text_loot");

    let results_text_mine = document.getElementById("results_text_mine");

    let results_text_tavern = document.getElementById("results_text_tavern");

    let results_text_summary = document.getElementById("results_text_summary");


    let results_table_loot = document.getElementById("results_table_loot");

    let results_table_mine = document.getElementById("results_table_mine");

    let results_table_tavern = document.getElementById("results_table_tavern");

    let results_table_summary = document.getElementById("results_table_summary");

    sync_data = [];

    localStorage.setItem("wallet", wallet);

    const totalByDayLoot = {}
    let totalTUSLoot = 0
    let totalCRALoot = 0
    let totalLoots = 0
    let totalWinsLoot = 0
    let totalLossesLoot = 0
    let teamsLoot = []
    const totalByDayMine = {}
    let totalTUSMine = 0
    let totalCRAMine = 0
    let totalMines = 0
    let totalWinsMine = 0
    let totalLossesMine = 0
    let teamsMine = []

    let rentcrabsid = []
    let totalTUSRent = 0
    let totalRents = 0
    const totalByDayRent = {}

    requests = []
    requests.push(fetch(`https://idle-api.crabada.com/public/idle/mines?looter_address=${wallet}&limit=20&status=close`).then(response => response.json()))
    requests.push(fetch(`https://idle-api.crabada.com/public/idle/mines?user_address=${wallet}&status=close&limit=20`).then(response => response.json()))
    requests.push(fetch(`https://idle-api.crabada.com/public/idle/crabadas/out-game?user_address=${wallet}&order=desc&limit=50`).then(response => response.json()))
    requests.push(fetch(`https://idle-api.crabada.com/public/idle/crabadas/for-lending?user_address=${wallet}&limit=50`).then(response => response.json()))
    requests.push(fetch(`https://idle-api.crabada.com/public/idle/teams?user_address=${wallet}&limit=20`).then(response => response.json()))

    Promise.all(requests).then(function (responses) {
      responses.forEach(r => {
        if (r.error_code) {
          let err = `${r.error_code} - ${r.message}`
          throw err
        }
      })
      const loots = responses[0]["result"]["data"]
      const totalLootPages = responses[0]["result"]["totalPages"]

      if (loots.length === 0) {
        results_text_loot.innerHTML += '<h4>Looting</h4>'
        results_text_loot.innerHTML += `You didn't loot yet. Go loot!`
        updateData("looting");
      } else {
        // get all pages
        pages_requests = []
        for (let i = 1; i <= totalLootPages; i++) {
          pages_requests.push(fetch(`https://idle-api.crabada.com/public/idle/mines?looter_address=${wallet}&limit=20&status=close&page=${i}`).then(response => response.json()))
        }


        Promise.all(pages_requests).then(function (pages_responses) {
          pages_responses.forEach(r => {
            if (r.error_code) {
              let err = `${r.error_code} - ${r.message}`
              throw err
            }

            pages_loots = r["result"]["data"]

            pages_loots.forEach(t => {
              const looter_cra_reward = t.looter_cra_reward
              const looter_tus_reward = t.looter_tus_reward
              const date = new Date(t.end_time * 1000)
              const day = date.toISOString().split('T')[0]
              if (!(day in totalByDayLoot)) {
                totalByDayLoot[day] = {}
                totalByDayLoot[day].cra = 0
                totalByDayLoot[day].tus = 0
                totalByDayLoot[day].loots = 0
                totalByDayLoot[day].wins = 0
                totalByDayLoot[day].losses = 0
              }
              if (!teamsLoot.includes(t.attack_team_id)) {
                teamsLoot.push(t.attack_team_id)
              }
              totalByDayLoot[day].cra += looter_cra_reward
              totalByDayLoot[day].tus += looter_tus_reward
              totalByDayLoot[day].loots += 1
              totalTUSLoot += looter_tus_reward
              totalCRALoot += looter_cra_reward
              totalLoots += 1
              if (t.attack_team_id == t.winner_team_id) {
                totalWinsLoot += 1
                totalByDayLoot[day].wins += 1

              } else {
                totalLossesLoot += 1
                totalByDayLoot[day].losses += 1
              }
            })
          })

        }).catch(function (error) {
          console.error(error);
          loading.innerHTML = error
        }).finally(() => {
          updateData("looting");
        });
      }


      const mines = responses[1]["result"]["data"]
      const totalMinePages = responses[1]["result"]["totalPages"]

      if (mines.length === 0) {
        results_text_mine.innerHTML += '<h4>Mining</h4>'
        results_text_mine.innerHTML += `You didn't mine yet. Go mine!`
        updateData("mining");
      } else {
        // get all pages
        pages_requests = []
        for (let i = 1; i <= totalMinePages; i++) {
          pages_requests.push(fetch(`https://idle-api.crabada.com/public/idle/mines?user_address=${wallet}&status=close&limit=20&page=${i}`).then(response => response.json()))
        }

        Promise.all(pages_requests).then(function (pages_responses) {
          pages_responses.forEach(r => {
            if (r.error_code) {
              let err = `${r.error_code} - ${r.message}`
              throw err
            }

            pages_mines = r["result"]["data"]

            pages_mines.forEach(t => {

              const miner_cra_reward = t.miner_cra_reward
              const miner_tus_reward = t.miner_tus_reward
              const date = new Date(t.end_time * 1000)
              const day = date.toISOString().split('T')[0]
              if (!(day in totalByDayMine)) {
                totalByDayMine[day] = {}
                totalByDayMine[day].cra = 0
                totalByDayMine[day].tus = 0
                totalByDayMine[day].mines = 0
                totalByDayMine[day].wins = 0
                totalByDayMine[day].losses = 0
              }
              if (!teamsMine.includes(t.team_id)) {
                teamsMine.push(t.team_id)
              }
              totalByDayMine[day].cra += miner_cra_reward
              totalByDayMine[day].tus += miner_tus_reward
              totalByDayMine[day].mines += 1
              totalTUSMine += miner_tus_reward
              totalCRAMine += miner_cra_reward
              totalMines += 1
              if (t.team_id == t.winner_team_id) {
                totalWinsMine += 1
                totalByDayMine[day].wins += 1

              } else {
                totalLossesMine += 1
                totalByDayMine[day].losses += 1
              }

            })
          })
        }).catch(function (error) {
          console.error(error);
          loading.innerHTML = error
        }).finally(() => updateData("mining"))
      }


      const outofgame = responses[2]["result"]["data"] || []
      if (outofgame.length > 0) {
        // get all pages
        pages_requests = []
        for (let i = 1; i <= totalMinePages; i++) {
          pages_requests.push(fetch(`https://idle-api.crabada.com/public/idle/crabadas/out-game?user_address=${wallet}&order=desc&limit=50&page=${i}`).then(response => response.json()))
        }

        Promise.all(pages_requests).then(function (pages_responses) {
          pages_responses.forEach(r => {
            if (r.error_code) {
              let err = `${r.error_code} - ${r.message}`
              throw err
            }

            pages_outofgame = r["result"]["data"]

            pages_outofgame.forEach(c => {
              rentcrabsid.push(c.crabada_id)
            })
          })
        }).catch(function (error) {
          console.error(error);
          loading.innerHTML = error
        }).finally(() => updateData("outofgame"));
      } else {
        updateData("outofgame");
      }


      const forlending = responses[3]["result"]["data"] || []
      if (forlending.length > 0) {
        // get all pages
        pages_requests = []
        for (let i = 1; i <= totalMinePages; i++) {
          pages_requests.push(fetch(`https://idle-api.crabada.com/public/idle/crabadas/for-lending?user_address=${wallet}&limit=50&page=${i}`).then(response => response.json()))
        }

        Promise.all(pages_requests).then(function (pages_responses) {
          pages_responses.forEach(r => {
            if (r.error_code) {
              let err = `${r.error_code} - ${r.message}`
              throw err
            }

            pages_forlending = r["result"]["data"]
            pages_forlending.forEach(c => {
              rentcrabsid.push(c.crabada_id)
            })
          })
        }).catch(function (error) {
          console.error(error);
          loading.innerHTML = error
        }).finally(() => updateData("forlending"));
      } else {
        updateData("forlending");
      }

      const crabsinteams = responses[4]["result"]["data"] || []
      if (crabsinteams.length > 0) {
        // get all pages
        pages_requests = []
        for (let i = 1; i <= totalMinePages; i++) {
          pages_requests.push(fetch(`https://idle-api.crabada.com/public/idle/teams?user_address=${wallet}&limit=20&page=${i}`).then(response => response.json()))
        }

        Promise.all(pages_requests).then(function (pages_responses) {
          pages_responses.forEach(r => {
            if (r.error_code) {
              let err = `${r.error_code} - ${r.message}`
              throw err
            }

            pages_crabsinteams = r["result"]["data"]
            if (pages_crabsinteams) {
              pages_crabsinteams.forEach(c => {
                if (c.crabada_id_1) {
                  rentcrabsid.push(c.crabada_id_1)
                }
                if (c.crabada_id_2) {
                  rentcrabsid.push(c.crabada_id_2)
                }
                if (c.crabada_id_3) {
                  rentcrabsid.push(c.crabada_id_3)
                }
              })
            }
          })
        }).catch(function (error) {
          console.error(error);
          loading.innerHTML = error
        }).finally(() => updateData("crabsinteams"));
      } else {
        updateData("crabsinteams");
      }


      let rentcrabsidPromise = new Promise((resolve, reject) => {
        let dataInterval = setInterval(function () {
          if (
            sync_data.includes("outofgame")
            && sync_data.includes("forlending")
            && sync_data.includes("crabsinteams")
          ) {
            clearInterval(dataInterval);
            resolve();
          }
        }, 500);
      });

      rentcrabsidPromise.then(() => {
        requestscrab = []
        rentcrabsid.forEach(id => {
          requestscrab.push(fetch(`https://idle-api.crabada.com/public/idle/crabadas/lending/history?crabada_id=${id}&limit=50`).then(response => response.json()))
        })
        Promise.all(requestscrab).then(function (responses) {
          console.log(responses)
          responses.forEach(response => {
            if (response.error_code) {
              let err = `${response.error_code} - ${response.message}`
              throw err
            }
            const transactions = response["result"]["data"]
            transactions.forEach(t => {
              const price = t.price
              totalTUSRent += price
              totalRents += 1
              const date = new Date(t.transaction_time * 1000)
              const day = date.toISOString().split('T')[0]
              if (!(day in totalByDayRent)) {
                totalByDayRent[day] = {}
                totalByDayRent[day].tus = 0
                totalByDayRent[day].rents = 0
              }
              totalByDayRent[day].tus += price
              totalByDayRent[day].rents += 1
            })

          })
        }).catch(function (error) {
          console.error(error);
          loading.innerHTML = error
        }).finally(() => updateData("renting"));
      })

      let dataPromise = new Promise((resolve, reject) => {
        let dataInterval = setInterval(function () {
          if (
            sync_data.includes("mining")
            && sync_data.includes("looting")
            && sync_data.includes("renting")
          ) {
            clearInterval(dataInterval);
            resolve();
          }
        }, 500);
      });

      dataPromise.then(() => {
        loading.innerHTML = "";
        let today = new Date()
        today = today.toISOString().split('T')[0]

        if (Object.keys(totalByDayLoot).length === 0) {
          results_text_loot.innerHTML += `You didn't loot yet. Go loot!`
        } else {
          number_for_avg = today in totalByDayLoot ? Object.keys(totalByDayLoot).length - 1 : Object.keys(totalByDayLoot).length
          number_for_avg = number_for_avg > 0 ? number_for_avg : 1

          dailyAvgTUS = totalTUSLoot / number_for_avg
          dailyAvgCRA = totalCRALoot / number_for_avg
          dailyAvgLoots = totalLoots / number_for_avg
          dailyAvgWins = totalWinsLoot / number_for_avg
          dailyAvgLosses = totalLossesLoot / number_for_avg

          dailyMax = Object.keys(totalByDayLoot).reduce((a, b) => totalByDayLoot[a].tus > totalByDayLoot[b].tus ? a : b);
          dailyMinFilter = Object.keys(totalByDayLoot).filter(v => v != today)
          dailyMin = dailyMinFilter.length > 0 ? dailyMinFilter.reduce((a, b) => totalByDayLoot[a].tus < totalByDayLoot[b].tus ? a : b) : today

          let statsloot = ''
          statsloot += `<table><tbody>`

          statsloot += `<tr><td>Total revenue</td><td>${(totalTUSLoot / 1.0e18).toFixed(4)} TUS and ${(totalCRALoot / 1.0e18).toFixed(4)} CRA</td></tr>`


          if (today in totalByDayLoot) {
            statsloot += `<tr><td>Today's revenue</td><td>${(totalByDayLoot[today].tus / 1.0e18).toFixed(4)} TUS and ${(totalByDayLoot[today].cra / 1.0e18).toFixed(4)} CRA (${today} - ${totalByDayLoot[today].loots} loots)</td></tr>`;
            statsloot += `<tr><td>Today's loots</td><td>${totalByDayLoot[today].loots} being ${totalByDayLoot[today].wins} wins and ${totalByDayLoot[today].losses} losses (${Math.round(100 * totalByDayLoot[today].wins / (totalByDayLoot[today].loots))}% win rate)</td></tr>`;
          } else {
            statsloot += `<tr><td>Today's revenue</td><td>No looting activity today. Go loot!</td></tr>`;
          }

          statsloot += `<tr><td>Average revenue per day</td><td>${(dailyAvgTUS / 1.0e18).toFixed(4)} TUS and ${(dailyAvgCRA / 1.0e18).toFixed(4)} CRA</td></tr>`;
          statsloot += `<tr><td>Best day</td><td>${(totalByDayLoot[dailyMax].tus / 1.0e18).toFixed(4)} TUS and ${(totalByDayLoot[dailyMax].cra / 1.0e18).toFixed(4)} CRA (${dailyMax} - ${totalByDayLoot[dailyMax].loots} loots)</td></tr>`;
          statsloot += `<tr><td>Worst day</td><td>${(totalByDayLoot[dailyMin].tus / 1.0e18).toFixed(4)} TUS and ${(totalByDayLoot[dailyMin].cra / 1.0e18).toFixed(4)} CRA (${dailyMin} - ${totalByDayLoot[dailyMin].loots} loots)</td></tr>`;
          statsloot += `<tr><td>Total loots</td><td>${totalLoots} being ${totalWinsLoot} wins and ${totalLossesLoot} losses (${Math.round(100 * totalWinsLoot / (totalLoots))}% win rate)</td></tr>`;
          statsloot += `<tr><td>Average loots per day</td><td>${dailyAvgLoots.toFixed(1)} being on average ${dailyAvgWins.toFixed(1)} wins and ${dailyAvgLosses.toFixed(1)} losses (${Math.round(100 * dailyAvgWins / (dailyAvgLoots))}% win rate)</td></tr>`;
          statsloot += `<tr><td>Number of teams</td><td>${teamsLoot.length}</td></tr>`


          statsloot += "</tbody></table></br>"
          results_text_loot.innerHTML += statsloot


          results_table_loot.innerHTML += `</br>Daily stats:</br>`

          let labels = []
          let data_values = []

          let tableloot = ''
          tableloot += `<table><thead><tr><th>Date</th><th>TUS</th><th>CRA</th><th>#Loots</th><th>Win rate</th></tr></thead><tbody>`

          Object.keys(totalByDayLoot).sort(function (a, b) {
            return moment(b, 'YYYY-MM-DD').toDate() - moment(a, 'YYYY-MM-DD').toDate();
          }).forEach(function (key) {
            labels.push(key)
            data_values.push((totalByDayLoot[key].tus / 1.0e18).toFixed(4))
            tableloot += `<tr><td>${key}</td><td>${(totalByDayLoot[key].tus / 1.0e18).toFixed(4)}</td><td>${(totalByDayLoot[key].cra / 1.0e18).toFixed(4)}</td><td>${totalByDayLoot[key].loots}</td><td>${Math.round(100 * totalByDayLoot[key].wins / (totalByDayLoot[key].loots))}%</td></tr>`
          })
          tableloot += "</tbody></table></br>"
          results_table_loot.innerHTML += tableloot

          if (!(today in totalByDayLoot)) {
            labels.push(today)
            data_values.push(0)
          }


          let data_loot = {
            labels: labels,
            datasets: [{
              label: 'TUS Revenue per day',
              backgroundColor: 'rgb(255, 99, 132)',
              borderColor: 'rgb(255, 99, 132)',
              data: data_values,
            }]
          };
          let chart1 = new Chart(document.getElementById('tus_revenue_chart_loot').getContext('2d'),
            {
              type: 'bar',
              data: data_loot,
              options: {
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: 'day'
                    }
                  }
                }
              }
            });
        }

        if (Object.keys(totalByDayMine).length === 0) {
          results_text_mine.innerHTML += `You didn't mine yet. Go mine!`
        } else {
          number_for_avg = today in totalByDayMine ? Object.keys(totalByDayMine).length - 1 : Object.keys(totalByDayMine).length
          number_for_avg = number_for_avg > 0 ? number_for_avg : 1

          dailyAvgTUS = totalTUSMine / number_for_avg
          dailyAvgCRA = totalCRAMine / number_for_avg
          dailyAvgMines = totalMines / number_for_avg
          dailyAvgWins = totalWinsMine / number_for_avg
          dailyAvgLosses = totalLossesMine / number_for_avg

          dailyMax = Object.keys(totalByDayMine).reduce((a, b) => totalByDayMine[a].tus > totalByDayMine[b].tus ? a : b);
          dailyMinFilter = Object.keys(totalByDayMine).filter(v => v != today)
          dailyMin = dailyMinFilter.length > 0 ? dailyMinFilter.reduce((a, b) => totalByDayMine[a].tus < totalByDayMine[b].tus ? a : b) : today

          let statsmine = ''
          statsmine += `<table><tbody>`

          statsmine += `<tr><td>Total revenue</td><td>${(totalTUSMine / 1.0e18).toFixed(4)} TUS and ${(totalCRAMine / 1.0e18).toFixed(4)} CRA</td></tr>`


          if (today in totalByDayMine) {
            statsmine += `<tr><td>Today's revenue</td><td>${(totalByDayMine[today].tus / 1.0e18).toFixed(4)} TUS and ${(totalByDayMine[today].cra / 1.0e18).toFixed(4)} CRA (${today} - ${totalByDayMine[today].mines} mines)</td></tr>`;
            statsmine += `<tr><td>Today's mines</td><td>${totalByDayMine[today].mines} being ${totalByDayMine[today].wins} wins and ${totalByDayMine[today].losses} losses (${Math.round(100 * totalByDayMine[today].wins / (totalByDayMine[today].mines))}% win rate)</td></tr>`;
          } else {
            statsmine += `<tr><td>Today's revenue</td><td>No mining activity today. Go mine!</td></tr>`;

          }

          statsmine += `<tr><td>Average revenue per day</td><td>${(dailyAvgTUS / 1.0e18).toFixed(4)} TUS and ${(dailyAvgCRA / 1.0e18).toFixed(4)} CRA</td></tr>`;
          statsmine += `<tr><td>Best day</td><td>${(totalByDayMine[dailyMax].tus / 1.0e18).toFixed(4)} TUS and ${(totalByDayMine[dailyMax].cra / 1.0e18).toFixed(4)} CRA (${dailyMax} - ${totalByDayMine[dailyMax].mines} mines)</td></tr>`;
          statsmine += `<tr><td>Worst day</td><td>${(totalByDayMine[dailyMin].tus / 1.0e18).toFixed(4)} TUS and ${(totalByDayMine[dailyMin].cra / 1.0e18).toFixed(4)} CRA (${dailyMin} - ${totalByDayMine[dailyMin].mines} mines)</td></tr>`;
          statsmine += `<tr><td>Total mines</td><td>${totalMines} being ${totalWinsMine} wins and ${totalLossesMine} losses (${Math.round(100 * totalWinsMine / (totalMines))}% win rate)</td></tr>`;
          statsmine += `<tr><td>Average mines per day</td><td>${dailyAvgMines.toFixed(1)} being on average ${dailyAvgWins.toFixed(1)} wins and ${dailyAvgLosses.toFixed(1)} losses (${Math.round(100 * dailyAvgWins / (dailyAvgMines))}% win rate)</td></tr>`;
          statsmine += `<tr><td>Number of teams</td><td>${teamsMine.length}</td></tr>`

          statsmine += "</tbody></table></br>"
          results_text_mine.innerHTML += statsmine

          results_table_mine.innerHTML += `</br>Daily stats:</br>`

          labels = []
          data_values = []
          let tablemine = ''
          tablemine += `<table><thead><tr><th>Date</th><th>TUS</th><th>CRA</th><th>#Mines</th><th>Win rate</th></tr></thead><tbody>`

          Object.keys(totalByDayMine).sort(function (a, b) {
            return moment(b, 'YYYY-MM-DD').toDate() - moment(a, 'YYYY-MM-DD').toDate();
          }).forEach(function (key) {
            labels.push(key)
            data_values.push((totalByDayMine[key].tus / 1.0e18).toFixed(4))
            tablemine += `<tr><td>${key}</td><td>${(totalByDayMine[key].tus / 1.0e18).toFixed(4)}</td><td>${(totalByDayMine[key].cra / 1.0e18).toFixed(4)}</td><td>${totalByDayMine[key].mines}</td><td>${Math.round(100 * totalByDayMine[key].wins / (totalByDayMine[key].mines))}%</td></tr>`

          })
          tablemine += "</tbody></table></br>"
          results_table_mine.innerHTML += tablemine

          if (!(today in totalByDayMine)) {
            labels.push(today)
            data_values.push(0)
          }

          let datamine = {
            labels: labels,
            datasets: [{
              label: 'TUS Revenue per day',
              backgroundColor: 'rgb(255, 99, 132)',
              borderColor: 'rgb(255, 99, 132)',
              data: data_values,
            }]
          };
          let chart2 = new Chart(document.getElementById('tus_revenue_chart_mine').getContext('2d'),
            {
              type: 'bar',
              data: datamine,
              options: {
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: 'day'
                    }
                  }
                }
              }
            });
        }

        if (Object.keys(totalByDayRent).length === 0) {
          results_text_tavern.innerHTML += `You didn't rent yet. Go rent!`
        } else {
          let statstavern = ''
          statstavern += `<table><tbody>`

          number_for_avg = today in totalByDayRent ? Object.keys(totalByDayRent).length - 1 : Object.keys(totalByDayRent).length
          number_for_avg = number_for_avg > 0 ? number_for_avg : 1

          dailyAvg = totalTUSRent / number_for_avg
          dailyAvgRents = totalRents / number_for_avg

          dailyMinFilter = Object.keys(totalByDayRent).filter(v => v != today)
          dailyMin = dailyMinFilter.length > 0 ? dailyMinFilter.reduce((a, b) => totalByDayRent[a].tus < totalByDayRent[b].tus ? a : b) : today

          dailyMax = Object.keys(totalByDayRent).reduce(function (a, b) {
            return totalByDayRent[a].tus > totalByDayRent[b].tus ? a : b
          });

          statstavern += `<tr><td>Total revenue</td><td>${(totalTUSRent / 1.0e18).toFixed(2)} TUS (${totalRents} rents)</td></tr>`

          if (today in totalByDayRent) {
            statstavern += `<tr><td>Today's revenue</td><td>${(totalByDayRent[today].tus / 1.0e18).toFixed(2)} TUS (${totalByDayRent[today].rents} rents)</td></tr>`;
          } else {
            statstavern += `<tr><td>Today's revenue</td><td>No renting activity today</td></tr>`;
          }
          statstavern += `<tr><td>Average revenue per day</td><td>${(dailyAvg / 1.0e18).toFixed(2)} TUS (${dailyAvgRents} rents)</td></tr>`;
          statstavern += `<tr><td>Best day</td><td>${(totalByDayRent[dailyMax].tus / 1.0e18).toFixed(2)} TUS (${dailyMax} - ${totalByDayRent[dailyMax].rents} rents)</td></tr>`;
          statstavern += `<tr><td>Worst day</td><td>${(totalByDayRent[dailyMin].tus / 1.0e18).toFixed(2)} TUS (${dailyMin} - ${totalByDayRent[dailyMin].rents} rents)</td></tr>`;

          statstavern += "</tbody></table></br>"
          results_text_tavern.innerHTML += statstavern


          results_table_tavern.innerHTML += `</br>Daily stats:</br>`

          labels = []
          data_values = []


          let tabletavern = ''
          tabletavern += `<table><thead><tr><th>Date</th><th>TUS</th><th>#Rents</th></tr></thead><tbody>`

          Object.keys(totalByDayRent).sort(function (a, b) {
            return moment(b, 'YYYY-MM-DD').toDate() - moment(a, 'YYYY-MM-DD').toDate();
          }).forEach(function (key) {
            labels.push(key)
            data_values.push((totalByDayRent[key].tus / 1.0e18).toFixed(2))
            tabletavern += `<tr><td>${key}</td><td>${(totalByDayRent[key].tus / 1.0e18).toFixed(2)}</td><td>${totalByDayRent[key].rents}</td></tr>`

          })
          tabletavern += "</tbody></table></br>"
          results_table_tavern.innerHTML += tabletavern

          if (!(today in totalByDayRent)) {
            labels.push(today)
            data_values.push(0)
          }

          let datatavern = {
            labels: labels,
            datasets: [{
              label: 'TUS Revenue per day',
              backgroundColor: 'rgb(255, 99, 132)',
              borderColor: 'rgb(255, 99, 132)',
              data: data_values,
            }]
          };
          let chart3 = new Chart(document.getElementById('tus_revenue_chart_tavern').getContext('2d'),
            {
              type: 'bar',
              data: datatavern,
              options: {
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: 'day'
                    }
                  }
                }
              }
            });
        }

        //SUMMARY
        const summary = {}
        let totalTUS = 0
        let totalCRA = 0
        Object.keys(totalByDayMine).sort(function (a, b) {
          return moment(b, 'YYYY-MM-DD').toDate() - moment(a, 'YYYY-MM-DD').toDate();
        }).reverse().forEach(function (t) {
          if (!(t in summary)) {
            summary[t] = {}
            summary[t].mine_tus = 0
            summary[t].mine_cra = 0
            summary[t].loot_tus = 0
            summary[t].loot_cra = 0
            summary[t].tavern_tus = 0
            summary[t].total_tus = 0
            summary[t].total_cra = 0
          }
          summary[t].mine_tus += totalByDayMine[t].tus
          summary[t].mine_cra += totalByDayMine[t].cra
          summary[t].total_tus += totalByDayMine[t].tus
          summary[t].total_cra += totalByDayMine[t].cra
          totalTUS += totalByDayMine[t].tus
          totalCRA += totalByDayMine[t].cra
        })

        Object.keys(totalByDayLoot).sort(function (a, b) {
          return moment(b, 'YYYY-MM-DD').toDate() - moment(a, 'YYYY-MM-DD').toDate();
        }).reverse().forEach(function (t) {
          if (!(t in summary)) {
            summary[t] = {}
            summary[t].mine_tus = 0
            summary[t].mine_cra = 0
            summary[t].loot_tus = 0
            summary[t].loot_cra = 0
            summary[t].tavern_tus = 0
            summary[t].total_tus = 0
            summary[t].total_cra = 0
          }
          summary[t].loot_tus += totalByDayLoot[t].tus
          summary[t].loot_cra += totalByDayLoot[t].cra
          summary[t].total_tus += totalByDayLoot[t].tus
          summary[t].total_cra += totalByDayLoot[t].cra
          totalTUS += totalByDayLoot[t].tus
          totalCRA += totalByDayLoot[t].cra
        })

        Object.keys(totalByDayRent).sort(function (a, b) {
          return moment(b, 'YYYY-MM-DD').toDate() - moment(a, 'YYYY-MM-DD').toDate();
        }).reverse().forEach(function (t) {
          if (!(t in summary)) {
            summary[t] = {}
            summary[t].mine_tus = 0
            summary[t].mine_cra = 0
            summary[t].loot_tus = 0
            summary[t].loot_cra = 0
            summary[t].tavern_tus = 0
            summary[t].total_tus = 0
            summary[t].total_cra = 0
          }
          summary[t].tavern_tus += totalByDayRent[t].tus
          summary[t].total_tus += totalByDayRent[t].tus
          totalTUS += totalByDayRent[t].tus
        })

        if (Object.keys(summary).length === 0) {
          results_text_summary.innerHTML += `No activity in this wallet.`
        } else {
          let statssummary = ''
          statssummary += `<table><tbody>`

          number_for_avg = today in summary ? Object.keys(summary).length - 1 : Object.keys(summary).length
          number_for_avg = number_for_avg > 0 ? number_for_avg : 1

          dailyAvgTUS = totalTUS / number_for_avg
          dailyAvgCRA = totalCRA / number_for_avg

          dailyMinFilter = Object.keys(summary).filter(v => v != today)
          dailyMin = dailyMinFilter.length > 0 ? dailyMinFilter.reduce((a, b) => summary[a].total_tus < summary[b].total_tus ? a : b) : today

          dailyMax = Object.keys(summary).reduce(function (a, b) {
            return summary[a].total_tus > summary[b].total_tus ? a : b
          });

          statssummary += `<tr><td>Total revenue</td><td>${(totalTUS / 1.0e18).toFixed(2)} TUS and ${(totalCRA / 1.0e18).toFixed(2)} CRA</td></tr>`

          if (today in summary) {
            statssummary += `<tr><td>Today's revenue</td><td>${(summary[today].total_tus / 1.0e18).toFixed(2)} TUS and ${(summary[today].total_cra / 1.0e18).toFixed(2)} CRA</td></tr>`;
          } else {
            statssummary += `<tr><td>Today's revenue</td><td>No activity today</td></tr>`;
          }
          statssummary += `<tr><td>Average revenue per day</td><td>${(dailyAvgTUS / 1.0e18).toFixed(2)} TUS and ${(dailyAvgCRA / 1.0e18).toFixed(2)} CRA</td></tr>`;
          statssummary += `<tr><td>Best day (TUS)</td><td>${(summary[dailyMax].total_tus / 1.0e18).toFixed(2)} TUS </td></tr>`;
          statssummary += `<tr><td>Worst day (TUS)</td><td>${(summary[dailyMin].total_tus / 1.0e18).toFixed(2)} TUS </td></tr>`;

          statssummary += "</tbody></table></br>"
          results_text_summary.innerHTML += statssummary

          results_table_summary.innerHTML += `</br>Daily stats:</br>`

          let tablesummary = ''
          tablesummary += `<table><thead><tr><th>Date</th><th>Mine (TUS)</th><th>Mine (CRA)</th><th>Loot (TUS)</th><th>Loot (CRA)</th><th>Tavern (TUS)</th><th>Total (TUS)</th><th>Total (CRA)</th></tr></thead><tbody>`
          labels = []
          data_values = []

          Object.keys(summary).sort(function (a, b) {
            return moment(b, 'YYYY-MM-DD').toDate() - moment(a, 'YYYY-MM-DD').toDate();
          }).forEach(function (key) {
            labels.push(key)
            data_values.push((summary[key].total_tus / 1.0e18).toFixed(2))
            tablesummary += `<tr><td>${key}</td><td>${(summary[key].mine_tus / 1.0e18).toFixed(2)}</td><td>${(summary[key].mine_cra / 1.0e18).toFixed(2)}</td><td>${(summary[key].loot_tus / 1.0e18).toFixed(2)}</td><td>${(summary[key].loot_cra / 1.0e18).toFixed(2)}</td><td>${(summary[key].tavern_tus / 1.0e18).toFixed(2)}</td><td>${(summary[key].total_tus / 1.0e18).toFixed(2)}</td><td>${(summary[key].total_cra / 1.0e18).toFixed(2)}</td></tr>`

          })
          tablesummary += "</tbody></table></br>"
          results_table_summary.innerHTML += tablesummary
          if (!(today in summary)) {
            labels.push(today)
            data_values.push(0)
          }

          data = {
            labels: labels,
            datasets: [{
              label: 'TUS Revenue per day',
              backgroundColor: 'rgb(255, 99, 132)',
              borderColor: 'rgb(255, 99, 132)',
              data: data_values,
            }]
          };
          chart = new Chart(document.getElementById('tus_revenue_chart_summary').getContext('2d'),
            {
              type: 'bar',
              data: data,
              options: {
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: 'day'
                    }
                  }
                }
              }
            });
        }

        document.getElementById("tab_1").click();
        results.style.display = "block";
      });
    }).catch(function (error) {
      console.error(error);
      loading.innerHTML = error
    })
  }

  function clearForm() {
    let results_text_mine = document.getElementById("results_text_mine");
    let results_text_loot = document.getElementById("results_text_loot");
    let results_text_tavern = document.getElementById("results_text_tavern");
    let results_text_summary = document.getElementById("results_text_summary");

    let results_table_mine = document.getElementById("results_table_mine");
    let results_table_loot = document.getElementById("results_table_loot");
    let results_table_tavern = document.getElementById("results_table_tavern");
    let results_table_summary = document.getElementById("results_table_summary");

    let results = document.getElementById("results");

    document.getElementById("tus_revenue_chart_loot").remove();
    let canvas = document.createElement('canvas');
    canvas.setAttribute('id', 'tus_revenue_chart_loot');
    document.querySelector('#chart_container_loot').appendChild(canvas);

    document.getElementById("tus_revenue_chart_mine").remove();
    canvas = document.createElement('canvas');
    canvas.setAttribute('id', 'tus_revenue_chart_mine');
    document.querySelector('#chart_container_mine').appendChild(canvas);

    document.getElementById("tus_revenue_chart_tavern").remove();
    canvas = document.createElement('canvas');
    canvas.setAttribute('id', 'tus_revenue_chart_tavern');
    document.querySelector('#chart_container_tavern').appendChild(canvas);

    document.getElementById("tus_revenue_chart_summary").remove();
    canvas = document.createElement('canvas');
    canvas.setAttribute('id', 'tus_revenue_chart_summary');
    document.querySelector('#chart_container_summary').appendChild(canvas);

    results_text_mine.innerHTML = "";
    results_text_loot.innerHTML = "";
    results_text_tavern.innerHTML = "";
    results_text_summary.innerHTML = "";
    results_table_mine.innerHTML = "";
    results_table_loot.innerHTML = "";
    results_table_tavern.innerHTML = "";
    results_table_summary.innerHTML = "";
    results.style.display = "none";

    let loading = document.getElementById("loading");
    loading.innerHTML = "";

  }

</script>

</html>
